## 三、Kettle使用

### 1、转换

- 功能：实现一个转换的程序
  - 输入：要读取什么数据进行转换
  - 转换：要对数据怎么进行处理【过滤、补全、转换】
  - 输出：要将处理好的数据保存到什么地方

![image-20200722114144063](img/image-20200722114144063-16468850643551.png)



### 2、作业

- 功能：将多个转换根据需求构建任务流

  - 任务流：很多个任务【每一个转换程序】根据自动运行的条件来运行就是任务流
  - 实际工作中，一次要执行很多个转换任务，如何实现这些任务的自动化执行
  - 自动运行
    - 第一种：定时运行
      - 每天的00:01分开始自动运行
    - 第二种：依赖关系
      - A先运行，A运行成功，B就自动运行

- 举例

  - 转换1：实现对数据的过滤

  - 转换2：实现对数据的补全

  - 转换3：实现对数据的转换

  - 作业：一个任务流

    - 转换1：每天00:10分自动运行
    - 转换2：转换1运行成功，转换2就开始运行
    - 转换3：转换2运行成功，转换3就开始运行

    ![image-20200722114924436](img/image-20200722114924436-16468850675792.png)

    





## 四、实战案例一

### 1、需求

- 将txt文件中的数据写入Excel表格中

### 2、分析

- 任务：一个转换程序
  - 输入：读取txt文件中内容
  - 转换：不需要
  - 输出：将内容加载到一个Excel文件中

### 3、实现

- step1：构建转换流程图

  - 新建一个转换任务

  - 将输入和输出拖入流程图的面板中

    ![image-20220111103200243](img/image-20220111103200243-16468850698903.png)

    

    ![image-20220111103421587](img/image-20220111103421587-16468850713304.png)

  - 连线

    ![image-20200722142722676](img/image-20200722142722676-16468850734085.png)

    

- step2：配置输入

  - 关联文件

  ![image-20200722143734940](img/image-20200722143734940-16468850750526.png)

  - 配置文件的格式

    ![image-20200722144128741](img/image-20200722144128741-16468850767447.png)

    

  - 选择输出到下一步的数据

    ![image-20200722144224932](img/image-20200722144224932-16468850782438.png)

    ![image-20200722144239822](img/image-20200722144239822-16468850801699.png)

    ![image-20200722144446344](img/image-20200722144446344-164688508185610.png)

    ![image-20200722144456628](img/image-20200722144456628-164688508346311.png)

    ![image-20200722144531292](img/image-20200722144531292-164688508495112.png)

    ![image-20200722144543660](img/image-20200722144543660-164688508645513.png)

    

- step3：配置输出

  - 预览输出信息

    ![image-20200722145005181](img/image-20200722145005181-1641871496086-164688508843114.png)

    

- step4：测试运行

  ![image-20220111105854406](img/image-20220111105854406-1641871491227-164688509037415.png)

  ![image-20220111111039953](img/image-20220111111039953-1641871482213.png)

  (WPS表格里数字字符过长时可能会显示#)



## 五、实战案例二

### 1、需求

- 读取Excel文件中的数据，存储MySQL中

### 2、分析

- 这是一个转换程序

- 输入：读取这个Excel文件

- 转换：不需要实现转换

- 输出：存储到MySQL中的表中

  - 数据库：kettle_demo

    ```
    create database kettle_demo;
    ```

    ![image-20220111111703519](img/image-20220111111703519-1641871473492.png)

    

  - 表：t_user

    - 让Kettle根据上游的数据自行创建

### 3、实现

- step1：构建转换流程图

  - 新建保存

    ![image-20220111112844678](img/image-20220111112844678.png)

    

- step2：配置输入

  - 定义输入的数据

    ![image-20220111113126937](img/image-20220111113126937.png)

    ![image-20200722154236283](img/image-20200722154236283.png)

    

  - 定义输出的字段

    ![image-20200722154439414](img/image-20200722154439414.png)

    ![image-20200722154624225](img/image-20200722154624225.png)

    ![image-20200722154639730](img/image-20200722154639730.png)

    ![image-20200722154716523](img/image-20200722154716523.png)

    

    

- step3：配置输出

  - 将连接MySQL的工具放入Kettle的lib目录中

    ![image-20200722160018987](img/image-20200722160018987.png)

    ![image-20200722160104092](img/image-20200722160104092.png)

    

  - ==**重新启动Kettle**==

  - 构建MySQL连接：地址、用户名、密码、数据库

    ![image-20200722155803639](img/image-20200722155803639-1642335524278.png)

    ![image-20200722160250214](img/image-20200722160250214.png)

    ![image-20200722160310389](img/image-20200722160310389.png)

    ![image-20200722160508104](img/image-20200722160508104.png)

    ![image-20200722160529093](img/image-20200722160529093.png)

    

    ![image-20220111114937678](img/image-20220111114937678.png)

    

- step4：测试运行

  ![image-20220111115026717](img/image-20220111115026717.png)

  ![image-20220111115728294](img/image-20220111115728294.png)

  


## 六、常用组件

### 1、共享数据库连接

- 新建的数据库连接都只属于某一个转换程序
- 如果你想让所有的转换程序都能使用这个连接，需要开启共享

![image-20200722165840910](img/image-20200722165840910-1642335536905.png)

![image-20200722165859797](img/image-20200722165859797-1642335538588.png)

![image-20200722165919365](img/image-20200722165919365-1642335540537.png)



### 2、表输入组件

- 需求：将t_user中的数据，同步到t_user1这张表中

- 分析

  - 这是一个转换任务
  - 输入：读取t_user表的数据
  - 转换：没有转换过程
  - 输出：将结果写入t_user1表中

- 实现

  - 开发程序

    ![image-20200722164702600](img/image-20200722164702600-1642335543676.png)

    

  - 配置输入

    - 先配置数据库连接共享

    ![image-20200722165958428](img/image-20200722165958428-1642335545595.png)

    ![image-20200722170047492](img/image-20200722170047492-1642335548196.png)

    ![image-20200722170105618](img/image-20200722170105618-1642335550019.png)

    ![image-20200722170215354](img/image-20200722170215354-1642335552065.png)

    ![image-20200722170330357](img/image-20200722170330357-1642335553699.png)

    

  - 配置输出

    ![image-20200722170419413](img/image-20200722170419413-1642335555867.png)

    ![image-20200722170438223](img/image-20200722170438223-1642335557827.png)

    ![image-20200722170452804](img/image-20200722170452804-1642335559621.png)

    

  - 测试运行

    ![image-20200722170536458](img/image-20200722170536458-1642335561432.png)

    ![image-20200722170549399](img/image-20200722170549399-1642335563041.png)

    ![image-20200722170622208](img/image-20200722170622208-1642335564566.png)

    ![image-20200722170632510](img/image-20200722170632510.png)

    

### 3、插入更新组件

- 工作需求：将 A表的数据同步到B表中，保证B表的数据与A表的数据一致，实现是不断更新的操作

  - A表发生了更新，更新的数据也会同步到B表中
  - A表没有发生更新，即使程序运行，B表也不发生改变
  - 数据同步的过程
    - 每次只同步更新的数据
    - 已经同步过的数据，就不会再进行同步
  - 工作中一般一天会同步一次，程序就每天执行一次

- 解决：插入更新的输出组件

- 功能：只会同步发生更新的数据，已经同步过的数据不会再次同步

  - 数据更新
    - 插入一条新的数据
    - 更改一条老的数据

- 实现：将t_user表的数据同步到t_user2中【任何的时刻，这两张表 数据同步时是一致的】

  - 开发转化 任务流程图

    ![image-20200722172727176](img/image-20200722172727176.png)

    

  - 定义输入

    ![image-20200722172804528](img/image-20200722172804528.png)

    ![image-20200722172825165](img/image-20200722172825165.png)

    

  - 定义输出

    ![image-20200722173646566](img/image-20200722173646566.png)

    ![image-20200722173715767](img/image-20200722173715767.png)

    ![image-20200722173750781](img/image-20200722173750781.png)

    ![image-20200722173859869](img/image-20200722173859869.png)

    ![image-20200722173918025](img/image-20200722173918025.png)

    ![image-20200722173939760](img/image-20200722173939760.png)

    

  - 测试运行

    ![image-20200722173956739](img/image-20200722173956739.png)

    ![image-20200722174010199](img/image-20200722174010199.png)

    ![image-20200722174019228](img/image-20200722174019228.png)

    ![image-20200722174035354](img/image-20200722174035354.png)

  - 如果修改了t_user的数据，重新执行程序，观察t_user2中的数据是否与t_user是一致的

    - 修改t_user的数据

      ![image-20200722174237259](img/image-20200722174237259.png)

      ![image-20200722174257213](img/image-20200722174257213.png)

    - 重新运行程序

      ![image-20200722174325258](img/image-20200722174325258.png)

    - 观察t_user2的数据

      ![image-20200722174412978](img/image-20200722174412978.png)

  - 同步业务

    - 全量：每次将所有的数据都同步一份
      - 保证A和B是一致的
        - 每次先删除B所有内容，然后，再同步
      - 程序的性能比较差，数据量大了以后，非常慢，不建议使用
      - 表输出：全量的组件
    - 增量：每次将发生更新的数据同步，没有发生更新就是已经同步过的数据不再同步
      - 保证A和B是一致的
      - 工作中都使用增量的方式
      - 插入更新：增量的组件



## 七、Kettle Job

### 1、Job的功能

- 转换：实现一种数据的转换处理，是一个转换任务
- 作业：实现多个转换任务按照一定的规则运行，就是一个任务流
  - 时间规则：从00:10分开始，每5种运行一次
  - 依赖规则：A成功了，就执行B
- 功能：将多个转换根据彼此之间的 关系实现任务流运行

### 2、Job的开发

- 需求：每5s就运行一个Kettle的转换任务

- 实现

  - 构建一个作业

    ![image-20200722184809959](img/image-20200722184809959.png)

    

  - 配置转换任务

    ![image-20200722185018655](img/image-20200722185018655.png)

    ![image-20200722184844483](img/image-20200722184844483.png)

    ![image-20200722184904596](img/image-20200722184904596.png)

    ![image-20200722184929577](img/image-20200722184929577.png)

    

  - 配置作业运行的规则

    ![image-20200722185004590](img/image-20200722185004590.png)

    ![image-20200722185211573](img/image-20200722185211573.png)

    

  - 运行

    ![image-20200722185247683](img/image-20200722185247683.png)

    ![image-20200722185310911](img/image-20200722185310911.png)



![image-20200722185421352](img/image-20200722185421352.png)

![image-20200722185439558](img/image-20200722185439558.png)



- 扩展：多个转换任务，按照时间以及顺序运行

  ![image-20200722185634596](img/image-20200722185634596.png)

  ![image-20200722185754113](img/image-20200722185754113.png)

  















